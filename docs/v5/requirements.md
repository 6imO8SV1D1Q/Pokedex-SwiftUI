# Pokédex SwiftUI - 要件定義書 v5.0

**プロジェクト名**: Pokédex SwiftUI
**バージョン**: 5.0
**作成者**: v5 要件定義チーム（ChatGPT支援）
**作成日**: 2025-10-20
**最終更新**: 2025-10-20

---

## 📋 目次

1. [概要](#概要)
2. [背景と目的](#背景と目的)
3. [機能要件](#機能要件)
4. [非機能要件](#非機能要件)
5. [データ要件](#データ要件)
6. [実装フェーズ](#実装フェーズ)
7. [除外事項・既知の制約](#除外事項既知の制約)
8. [未解決事項](#未解決事項)

---

## 概要

### バージョン5.0のテーマ
**「スカーレット・バイオレット対応ダメージ計算体験の提供」**

第5期では、プレイヤーが攻撃・防御双方のパラメータを細かく調整しながら公式ルール準拠のダメージ結果を確認できる「ダメージ計算画面」を新設する。テラスタル、オーガポン固有補正、天候・フィールドなど第9世代特有の要素をUI・計算ロジックの両面でサポートし、既存の図鑑体験を対戦準備まで拡張する。

---

## 背景と目的

1. **対戦準備機能の不足**
   - 現行アプリはポケモン・技のブラウズに特化しており、実戦を想定したダメージ検証が行えない。
   - 既存の外部サイトに頼る必要があり、アプリ内で完結しない。

2. **第9世代固有要素への対応ニーズ**
   - テラスタル、オーガポン固有補正、フィールド効果など複雑な要素を加味した計算が求められている。
   - 既存のScarlet/Violet JSON資産を活用しつつ、新たにアイテムデータを整備する必要がある。

3. **UXの近代化**
   - 一般的なダメージ計算ツールに匹敵する操作感（検索、ワンタップ切替、ターンシミュレーション）をSwiftUIで実現する。

---

## 機能要件

### FR-5.1 ダメージ計算画面の追加
- Pokédexアプリ内に新規タブ（またはモーダル）としてダメージ計算画面を配置する。
- 画面遷移時に現行図鑑データ（ポケモン、技、タイプなど）を読み込み、即座に選択できること。

### FR-5.2 攻撃側・防御側の入力UI
- レベル、性格、努力値（EV）、個体値（IV）、ステータス補正ランクを入力可能にする。
- 技、持ち物、特性をそれぞれ検索またはピッカーで選択できる。
- ワンタップで攻撃側と防御側の構成を丸ごと入れ替えられる切替ボタンを提供する。
- シングル／ダブルバトルをトグルで切り替え、入力項目や補正をモードに応じて適用する。

### FR-5.3 タイプ・テラスタル入力
- 通常タイプとテラスタイプを明確に区別したUI（例: 2段のタイプ選択、バッジ色分けなど）を提供する。
- テラスタルオン／オフを制御できるトグルを設置し、計算ロジックに反映する。

### FR-5.4 環境・補助条件の入力
- 天候（晴れ・雨・砂嵐など）、フィールド（エレキ、グラス等）、壁・オーロラベールなどのバトルフィールド効果を入力できる。
- ステルスロック、まきびし等の設置技によるHP減少を考慮した初期HPを設定できる。
- 状態異常・ひるみ等はv5では非対応と明示する。

### FR-5.5 ダメージ計算ロジック
- 公式のダメージ計算式を完全実装する。
- テラスタル時のタイプ一致補正、タイプ相性変化を公式仕様通りに処理する。
- オーガポン固有の補正条件・倍率を実装し、該当ポケモン・フォルムでのみ適用する。
- オーガポン固有補正の詳細:
  - フォルムとマスクの対応: 碧の仮面（草単）、いどのめん（草/水）、かまどのめん（草/炎）、いしずえのめん（草/岩）。
  - 対応マスクを所持したオーガポンが自分のマスクと同じタイプの攻撃を行う場合、非テラスタル時は威力1.2倍、テラスタル時は1.3倍を追加で乗算する（Ivy Cudgelを含む）。
  - テラスタル時はマスク固有タイプに単タイプ化し、通常STAB（1.5）とテラスタル追加補正（マッチング時2.0）に加え上記マスク倍率を反映する。
  - マスクはバトル中に奪取不可とし、テラスタルしない場合でも1.2倍補正が適用されることを確認する。
  - 各フォルム×テラスタル有無のテストケース（例: テラス草の碧の仮面、テラス水のいどのめん等）を用意し、ダメージ期待値が既存ツールと一致することを検証する。
- シングル／ダブルバトルで補正が異なる要素（範囲技、味方バフ等）を反映する。

### FR-5.6 連続ターン撃破確率
- ユーザーが1ターン目と2ターン目に使用する技を指定し、連続ダメージから撃破確率を算出する。
- ダメージ乱数、急所、命中率などの確率要素を公式ルールに従って評価し、結果を%表示する。
- 2ターン目計算時は1ターン目のHP減少結果を考慮する。

### FR-5.7 結果表示
- 最小～最大ダメージ、確定数（○発）、撃破確率を表示する。
- HPバー風のビジュアル表示と、条件サマリー（天候、フィールド、補正一覧）を提示する。
- 計算条件のシェア・コピー（テキスト化）を可能にする。

### FR-5.8 入力補助
- ポケモン、技、アイテム、特性の選択コンポーネントに検索バーまたはフィルターを提供する。
- よく使う項目の履歴またはお気に入りを保存し、次回以降素早く選択できるようにする。
- 入力途中でも状態が保持され、画面を閉じても次回復帰できるようにする（UserDefaults 等）。

---

## 非機能要件

### NFR-5.1 パフォーマンス
- 主要操作（ポケモン／技検索、条件切替）はユーザー操作から300ms以内に応答する。
- 1回のダメージ計算（シングル）は50ms以内、連続ターンの確率算出でも500ms以内を目標とする。

### NFR-5.2 オフライン対応
- ダメージ計算に必要なデータ（ポケモン基本データ、技、特性、アイテムJSON）はローカルに存在し、オフラインでも利用可能とする。

### NFR-5.3 品質保証
- 公式資料や既存ダメージ計算ツールとの照合テストケースを作成し、自動テストで回帰を防止する。
- 特殊ケース（テラスタル、オーガポン、ダブルバトル、壁ありなど）を網羅したユニットテストを準備する。

### NFR-5.4 UX一貫性
- 既存Pokédexアプリのデザインシステムに準拠しつつ、外部ダメージ計算サイトに近い操作感を目指す。
- VoiceOver等アクセシビリティを意識し、主要コンポーネントにラベルを付与する。

---

## データ要件

1. **ポケモンデータ**: 既存の `scarlet_violet.json` を参照し、追加項目が必要になった場合は後続バージョンで拡張する。
2. **技データ**: 既存データを利用。テラスタルとの相互作用（例: タイプ一致）を計算層で処理する。
3. **アイテムデータ**:
   - PokeAPIから取得し、`Resources/PreloadedData/items_v5.json`（仮）としてバンドルする。
   - 各レコードにID、名称（英/日）、効果概要、ダメージ補正種別、対象（攻撃/防御）、テラスタル関連フラグ等を含める。
   - オーガポン用マスクには非テラスタル倍率（1.2）・テラスタル倍率（1.3）・対象タイプを明記し、計算層で参照できるようにする。
   - バージョン管理し、更新手順をドキュメント化する。
4. **特性データ**: 既存データを活用し、ダメージ計算に関係するフラグ（例: フィルター、もらいび）を整理する。
5. **プリセット保存**: ユーザー設定のプリセットをJSONまたはUserDefaultsでローカル保存し、外部共有（URL/ファイル）はv5範囲外とする。バージョン番号を付与する。

---

## 実装フェーズ

### Phase 1: UI基盤と状態管理
- ダメージ計算画面のナビゲーション導線を追加。
- 攻撃側/防御側パネル、シングル/ダブル切替、タイプ選択UIを実装。
- 入力状態の保持・リセット・プリセット読み書きを実装。

### Phase 2: データ整備
- PokeAPI取得スクリプトを整備し、アイテムJSONを生成。
- JSONロード・キャッシュ層を実装し、既存データモデルと統合。
- 入力補助（検索、フィルター、履歴）を構築。

### Phase 3: 計算エンジン
- 公式ダメージ式、テラスタル処理、オーガポン補正、シングル/ダブル補正を実装。
- 2ターン撃破確率シミュレータを構築し、結果表示と連携。
- テストケースを整備し、自動化（Unit/UIテスト）する。

### Phase 4: 仕上げ
- UX改善、アクセシビリティ対応、デザイン微調整。
- ドキュメント整備、既知の制約や今後の課題を明文化。

---

## 除外事項・既知の制約

- 状態異常（やけど、まひ等）やひるみ、追加効果確率はv5では扱わない。
- Zワザやダイマックスなど第9世代対象外のバトルシステムは非対応。
- ネットワーク越しの最新データ取得は手動更新（将来の自動更新は検討事項）。
- マルチバトル／ローテーション等の特殊ルールは対象外。

---

## 未解決事項

1. **アイテムJSONの確定スキーマ**
   - PokeAPIのレスポンス構造調査と、アプリ側のキー命名（例: `effectCategory`, `teraBonusMultiplier` 等）を設計段階で確定する。

2. **ダブルバトル固有ロジックの詳細**
   - 範囲技ダメージ補正や味方サポートの公式仕様を資料化し、実装前にリファレンスを整理する。

3. **オーガポン補正テストケース**
   - 上記仕様を元にダメージ計算のゴールデンデータを収集（公式資料／既存ツール比較）し、ユニットテストへ落とし込む。

---

## ステークホルダー承認

- **承認者**: プロダクトオーナー（ユーザー）
- **承認日**: 2025-10-20
- **メモ**: 「要件内容に問題なし。設計フェーズへ進行してください。」

---

## ドキュメント更新履歴

- 2025-10-20: v5要件定義の初版を作成。
- 2025-10-21: ステークホルダー承認セクションとオーガポン補正要件を追記。

---

本ドキュメントはv5開発に向けた初版の要件定義であり、開発進捗や追加ヒアリングに応じて更新する。

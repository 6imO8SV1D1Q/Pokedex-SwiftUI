# Pokedex-SwiftUI 要件定義書 v3.0

## 1. 概要

### 1.1 目的
ポケモン詳細画面の大幅拡充により、ユーザーがポケモンの情報をより深く理解できるようにする。

### 1.2 対象バージョン
- バージョン: v3.0
- リリース形態: 全機能を含む一括リリース

### 1.3 主な追加機能
- フォルム切り替え（リージョンフォーム、メガシンカ等）
- 図鑑説明（フレーバーテキスト）
- タイプ相性表示（攻撃面・防御面）
- 進化ルートのツリー表示
- 生息地表示
- 実数値計算（5パターン）
- 特性の詳細説明
- 技一覧の拡充（TM番号、技詳細情報）
- 性別比・たまごグループ表示

---

## 2. 詳細画面の構成

詳細画面は以下の順序でセクションを表示する。全セクションはデフォルトで展開状態。

### 2.1 画面構成（上から順）

1. **ポケモン画像・基本情報**（常に表示）
2. **フォルムドロップダウン**
3. **タイプ相性**
4. **図鑑説明**
5. **進化ルート**
6. **生息地**
7. **種族値表示**（既存機能）
8. **実数値**
9. **特性**
10. **覚える技**

### 2.2 スクロール方式
- 縦スクロールで全セクションを表示
- 各セクションは折りたたみ可能（デフォルト：全展開）
- 進化ルートは横方向に伸びる場合、横スクロール対応

---

## 3. 各機能の詳細仕様

### 3.1 ポケモン画像・基本情報（既存 + 拡張）

#### 3.1.1 既存要素
- ポケモン画像
- 色違いトグル（既存機能を維持）
- 図鑑番号
- ポケモン名
- タイプ表示
- 身長
- 体重

#### 3.1.2 新規追加要素
- **性別比**
  - 表示形式: `♂ 87.5% / ♀ 12.5%`
  - 性別不明の場合: `性別不明`
- **たまごグループ**
  - 複数所属する場合は全て表示（例: `すいちゅう1、りくじょう`）
  - 未発見の場合: `みはっけん`

---

### 3.2 フォルムドロップダウン

#### 3.2.1 対象フォーム
選択中のバージョングループに存在する以下のフォームを表示：
- リージョンフォーム（アローラ、ガラル、ヒスイなど）
- フォルムチェンジ（ロトム、デオキシスなど）
- メガシンカ（選択中のバージョングループに存在する場合のみ）
- ゲンシカイキ（選択中のバージョングループに存在する場合のみ）

**対象外:**
- キョダイマックス（ステータス変化がないため）

#### 3.2.2 表示方法
- ドロップダウン形式で選択
- 選択肢: 「通常」「アローラ」「ガラル」など
- フォームが1つしかない場合もドロップダウンを表示（選択肢1つ）

#### 3.2.3 フォーム切り替え時の動作
フォームを切り替えると、以下の情報が自動更新される：
- ポケモン画像
- タイプ表示
- タイプ相性
- 種族値
- 実数値
- 特性（該当する場合）

#### 3.2.4 色違いとの関係
- 色違いトグルは独立して動作
- フォーム選択後も色違いトグルの状態を維持
- 例: 色違いON + ヒートロトム選択 → 色違いヒートロトムを表示

---

### 3.3 タイプ相性

#### 3.3.1 表示内容
攻撃面と防御面を分けて表示：

**【攻撃面】このポケモンの技が効果ばつぐん**
- 効果ばつぐんになるタイプを列挙

**【防御面】このポケモンが受けるダメージ**
- 効果ばつぐん（4倍）
- 効果ばつぐん（2倍）
- いまひとつ（1/2倍）
- いまひとつ（1/4倍）
- 効果なし

#### 3.3.2 表示形式
```
▼ タイプ相性

【攻撃面】
効果ばつぐん: くさ、むし

【防御面】
効果ばつぐん（4倍）: いわ
効果ばつぐん（2倍）: みず、でんき
いまひとつ（1/2倍）: ほのお、くさ、かくとう、はがね、フェアリー
いまひとつ（1/4倍）: むし
効果なし: じめん
```

#### 3.3.3 タイプの並び順
- 各倍率グループ内で、タイプ番号順に表示
- 等倍のタイプは表示しない

#### 3.3.4 フォーム連動
- フォームドロップダウンで選択を変更すると、タイプ相性も自動更新
- 例: ロトム（でんき・ゴースト） → ヒートロトム（でんき・ほのお）

---

### 3.4 図鑑説明

#### 3.4.1 表示内容
- 選択中のバージョングループの図鑑説明文（フレーバーテキスト）を表示

#### 3.4.2 表示形式
```
▼ 図鑑説明

背中に しょくぶつの タネが うえてあって
せいちょうと ともに おおきく そだつという。
```

#### 3.4.3 データ取得
- PokéAPIから取得
- 選択中のバージョングループに対応する説明文を表示
- データがない場合: 空欄または「説明なし」

---

### 3.5 進化ルート

#### 3.5.1 表示形式
- ツリー状の表示（横方向: 左→右）
- 進化前が左、進化後が右
- 分岐がある場合は縦に展開
- 横に長くなる場合は横スクロール対応

#### 3.5.2 各ポケモンの表示情報
- ポケモン画像（小サイズ）
- ポケモン名
- 図鑑番号
- タイプアイコン
- 進化条件（矢印または線で接続）

#### 3.5.3 進化条件の表示
PokéAPIで取得できる以下の情報を表示：
- レベル（例: `Lv.16`）
- 進化石（例: `みずのいし`）
- 通信交換（例: `通信交換`）
- なつき度（例: `なつき度`）
- 特定技習得（例: `まねっこ習得`）
- 持ち物（例: `おうじゃのしるし+通信交換`）
- 時間帯（例: `なつき度+朝昼`、`なつき度+夜`）
- その他の条件（PokéAPIから取得できる範囲で全て表示）

**対象外:**
- 入手場所の詳細情報

#### 3.5.4 タップ操作
- 進化ツリー内のポケモンをタップすると、そのポケモンの詳細画面に遷移
- 戻るボタンで元の画面に戻る

#### 3.5.5 進化しないポケモン
- 進化ルートセクションを表示
- 現在のポケモンのみを表示（「このポケモンのみ」的な見せ方）

#### 3.5.6 表示例

**通常進化（フシギダネ）:**
```
[フシギダネ] --Lv.16--> [フシギソウ] --Lv.32--> [フシギバナ]
 #001           #002          #003
 くさ・どく      くさ・どく      くさ・どく
```

**分岐進化（イーブイ）:**
```
                  ┌-- みずのいし --> [シャワーズ] #134
                  ├-- かみなりのいし --> [サンダース] #135
                  ├-- ほのおのいし --> [ブースター] #136
[イーブイ] #133 --├-- なつき度+朝昼 --> [エーフィ] #196
  ノーマル         ├-- なつき度+夜 --> [ブラッキー] #197
                  ├-- リーフのいし --> [リーフィア] #470
                  ├-- こおりのいし --> [グレイシア] #471
                  └-- なつき度+フェアリー技 --> [ニンフィア] #700
```

---

### 3.6 生息地

#### 3.6.1 表示内容
- 選択中のバージョングループでの出現場所を表示
- 例: `1ばんどうろ`、`ハナダのどうくつ`

#### 3.6.2 表示形式
```
▼ 生息地

1ばんどうろ、2ばんどうろ、トキワのもり
```

#### 3.6.3 データがない場合
- `生息地不明` と表示
- セクション自体は表示する

#### 3.6.4 データ取得
- PokéAPIから取得
- 取得できない場合は「生息地不明」

---

### 3.7 種族値表示（既存機能）

既存の種族値表示を維持。フォーム切り替え時には自動更新される。

---

### 3.8 実数値

#### 3.8.1 計算条件
- レベル: 50固定
- 5パターンを表示

#### 3.8.2 5パターンの詳細

| パターン | 個体値 | 努力値 | 性格補正 |
|---------|-------|-------|---------|
| 理想 | 31 | 252 | 上昇補正（1.1倍） |
| 252 | 31 | 252 | 補正なし |
| 無振り | 31 | 0 | 補正なし |
| 最低 | 0 | 0 | 補正なし |
| 下降 | 0 | 0 | 下降補正（0.9倍） |

#### 3.8.3 表示形式
表形式で表示。左から右へ数値が高い順。

```
▼ 実数値（Lv.50）

        理想   252   無振り  最低   下降
        252↑   252   31-0   0-0   0-0↓
HP:     175   170    155   140   140
攻撃:   167   152    137   105   94
防御:   159   145    130   98    88
特攻:   167   152    137   105   94
特防:   159   145    130   98    88
素早さ: 156   142    127   96    86
```

#### 3.8.4 HPの扱い
- HPは性格補正がないため、「最低」と「下降」は同じ値になる
- 列の統一性のため、同じ値を2回表示する

#### 3.8.5 フォーム連動
- フォーム切り替え時に種族値が変わる場合、実数値も自動更新

---

### 3.9 特性

#### 3.9.1 表示内容
- 特性名
- 特性の説明文（effectテキスト）
- 隠れ特性の表示

#### 3.9.2 表示形式
```
▼ 特性

【通常特性】
しんりょく
When this Pokémon has 1/3 or less of its HP remaining, its grass-type moves inflict 1.5× as much regular damage.

【隠れ特性】
ようりょくそ
This Pokémon's Speed is doubled during strong sunlight.
```

#### 3.9.3 説明文の言語
- PokéAPIのeffect（対戦向け説明）を使用
- 日本語が取得できない場合は英語で表示
- 日本語化は今後の課題

#### 3.9.4 バージョングループによる表示制御
- 第1〜2世代: 特性システムが未実装のため、セクション自体を非表示
- 第3〜4世代: 通常特性のみ表示
- 第5世代以降: 通常特性 + 隠れ特性を表示

#### 3.9.5 複数の通常特性
- 通常特性が複数ある場合は全て表示
- 例: ニドラン♀（どくのトゲ、とうそうしん）

---

### 3.10 覚える技

#### 3.10.1 表示内容
技ごとに以下の情報を表示：
- 技名
- タイプ
- 分類（物理/特殊/変化）
- 威力（変化技の場合は `-`）
- 命中率
- PP
- 習得方法
- 習得レベル（レベルアップの場合のみ）

#### 3.10.2 表示形式
習得方法ごとにセクション分けして一覧表示。

```
▼ 覚える技

【レベルアップ】
Lv.1  ひっかく    ノーマル 物理 40  100  35
Lv.7  ひのこ      ほのお   特殊 40  100  25
Lv.13 えんまく    ノーマル 変化 -   100  20
...

【わざマシン（TM）】
TM01  メガトンパンチ  ノーマル 物理 80  85   20
TM08  はかいこうせん ノーマル 特殊 150 90   5
TM24  10まんボルト   でんき   特殊 90  100  15
...

【わざレコード（TR）】※剣盾以降
TR24  げきりん       ドラゴン 物理 120 100  10
TR12  こうそくいどう エスパー 変化 -   -    30
...

【ひでんマシン（HM）】
HM03  なみのり       みず     特殊 90  100  15
...

【タマゴわざ】
りゅうのいかり     ドラゴン 特殊 -   100  10
かえんほうしゃ     ほのお   特殊 90  100  15
...

【おしえわざ】
ほのおのちかい     ほのお   特殊 80  100  10
...
```

#### 3.10.3 技の並び順
- **レベルアップ**: レベル順（昇順）
- **TM/HM/TR**: 番号順
- **タマゴわざ**: 名前順（五十音順）
- **おしえわざ**: 名前順（五十音順）

#### 3.10.4 TM番号の表示
- TM/HM/TRの種類を明示（例: `TM24`、`HM03`、`TR12`）
- バージョングループによって番号が異なる場合、選択中のバージョンに対応した番号を表示

#### 3.10.5 技タップ時の動作
- 今回は実装しない（将来の拡張として検討）
- 技詳細モーダルやポップアップは v3.0 には含まない

#### 3.10.6 ソート機能
- 今回は実装しない（将来の拡張として検討）

#### 3.10.7 習得できない習得方法
- 該当する習得方法がない場合、そのセクションは非表示
- 例: レベルアップ技しかないポケモンは「レベルアップ」セクションのみ表示

---

## 4. データ仕様

### 4.1 PokéAPI連携

#### 4.1.1 主要エンドポイント
- `/pokemon/{id}`: 基本情報、種族値、タイプ、特性
- `/pokemon-species/{id}`: 図鑑説明、進化チェーン、性別比、たまごグループ
- `/evolution-chain/{id}`: 進化ルート
- `/pokemon/{id}/encounters`: 生息地情報
- `/move/{id}`: 技の詳細情報
- `/ability/{id}`: 特性の詳細情報
- `/type/{id}`: タイプ相性情報
- `/pokemon-form/{id}`: フォーム情報

#### 4.1.2 調査事項（設計段階で実施）
以下の項目について、PokéAPIで取得可能な情報の範囲を調査する：
- 進化条件の詳細度（レベル、石、持ち物、時間帯、場所など）
- フォーム情報の構造（リージョン、メガシンカ、フォルムチェンジの区別）
- 特性・技の説明文（日本語effectの有無）
- 生息地情報の詳細度
- TM/HM/TR番号のバージョンごとの管理方法

### 4.2 バージョングループ対応

#### 4.2.1 バージョングループによる変化
選択中のバージョングループに応じて以下が変化：
- 種族値
- 特性（世代による表示制御）
- 覚える技とTM/HM/TR番号
- 存在するフォーム
- 図鑑説明
- 生息地

#### 4.2.2 データの整合性
- フォーム切り替え時も、選択中のバージョングループの仕様を維持
- 例: 赤・緑選択中にアローラフォームは表示されない

---

## 5. 非機能要件

### 5.1 エラー処理
- 既存のエラー処理実装に準拠
- 既存実装がない場合は新規作成
- PokéAPIからのデータ取得失敗時、適切なエラーメッセージを表示
- リトライ機能は既存実装に従う

### 5.2 パフォーマンス
- PokéAPIへのリクエストは必要最小限に抑える
- キャッシュ機構を活用（既存のKingfisher、メモリキャッシュ）
- 大量の技データ取得時の最適化

### 5.3 アクセシビリティ
- VoiceOver対応（既存実装に準拠）
- Dynamic Type対応
- 色覚多様性への配慮（タイプアイコン、相性表示）

### 5.4 UI/UX
- スクロールパフォーマンスの維持
- 画面遷移のスムーズさ
- ローディング状態の適切な表示

---

## 6. 実装方針

### 6.1 アーキテクチャ
- Clean Architecture + MVVM を維持
- Domain層、Data層、Presentation層の責務を明確に分離

### 6.2 レイヤー構成

#### 6.2.1 Domain層
- 新規Entity追加: `PokemonForm`, `TypeMatchup`, `BaseStats` 等
- 新規UseCase追加: `FetchPokemonFormsUseCase`, `CalculateStatsUseCase`, `FetchTypeMatchupUseCase` 等

#### 6.2.2 Data層
- リポジトリの拡張: `PokemonRepository` に新規メソッド追加
- 新規APIクライアント: 必要に応じて追加
- キャッシュ層の拡張

#### 6.2.3 Presentation層
- `PokemonDetailViewModel` の拡張
- 新規View追加: `EvolutionTreeView`, `TypeMatchupView`, `StatsCalculatorView` 等

### 6.3 テスト戦略
- ユニットテスト: 新規UseCaseとViewModelをカバー
- 統合テスト: API連携とデータフローをテスト
- UIテスト: 主要な画面遷移と操作をテスト（可能な範囲で）

### 6.4 段階的実装
v3.0として一括リリースするが、実装は以下の順序で進める：

1. **フェーズ1: データ層の拡充**
   - PokéAPI調査
   - 新規Entity、Repository実装
   - データ取得ロジック実装

2. **フェーズ2: 基本表示機能**
   - フォルム切り替え
   - 図鑑説明
   - 性別比・たまごグループ

3. **フェーズ3: 高度な表示機能**
   - タイプ相性
   - 進化ルート（ツリー表示）
   - 生息地

4. **フェーズ4: 計算・詳細機能**
   - 実数値計算
   - 特性詳細
   - 技一覧拡充

5. **フェーズ5: テスト・最適化**
   - ユニットテスト追加
   - パフォーマンス最適化
   - バグフィックス

---

## 7. 今後の課題（v3.0対象外）

以下の項目は v3.0 では実装せず、今後の課題として記録：

### 7.1 UI刷新
- 詳細画面全体のUIデザイン見直し
- TM/HM/TRの説明表示方法の改善
- フォーム切り替えUIの改善

### 7.2 多言語対応
- 特性・技の説明文の日本語化
- 英語以外の言語サポート

### 7.3 インタラクティブ機能
- 技タップ時の詳細モーダル表示
- 技のソート・フィルター機能
- 実数値計算のカスタマイズ（レベル、努力値入力）

### 7.4 その他
- タイプ相性チェッカー（独立した機能として）
- ポケモン比較機能
- お気に入り機能

---

## 8. 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|----------|------|---------|--------|
| v3.0 | 2025-10-06 | 詳細画面の大幅拡充に関する要件定義 | Yusuke Abe |

---

## 9. 承認

| 役割 | 氏名 | 承認日 |
|-----|------|--------|
| 要件定義者 | Yusuke Abe | 2025-10-06 |
| レビュワー | - | - |

---

**以上**
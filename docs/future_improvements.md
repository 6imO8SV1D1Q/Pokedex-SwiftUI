# 今後の改善課題

このドキュメントは、Pokédex SwiftUIアプリの既知の課題と、今後実装すべき改善点をまとめたものです。

## 📅 最終更新日
2025-10-07

---

## 🔴 高優先度の課題

### 1. 起動時の大量ネットワークエラー（URLError.cancelled）

**現状の問題**:
- アプリ起動時に`fetchAllPokemon`が呼ばれ、大量のネットワークリクエスト（1000件以上）が並列実行される
- 並列度が高すぎるため、多くのリクエストがキャンセルされ、コンソールに大量のエラーログが出力される
- 例: `Failed to fetch Pokemon: other(Error Domain=NSURLErrorDomain Code=-999 "cancelled")`

**原因**:
```swift
// PokemonAPIClient.swift:187-197（修正前）
let batchSize = 50  // 並列度が高すぎる
let batchPokemons = try await withThrowingTaskGroup(of: Pokemon?.self) { group in
    for resource in batch {
        group.addTask {
            // 50件同時にリクエスト → ネットワークがキャンセル
            let pkm = try await self.pokemonAPI.resourceService.fetch(resource)
            return PokemonMapper.map(from: pkm)
        }
    }
}
```

**暫定対応（2025-10-07）**:
1. **並列度の削減**
   - バッチサイズを50 → 10に変更
   - ネットワークの負荷を軽減

2. **エラーハンドリングの改善**
   ```swift
   catch {
       // キャンセルエラーは無視、その他のエラーのみログ出力
       if let urlError = error as? URLError, urlError.code == .cancelled {
           return nil
       }
       print("⚠️ Failed to fetch Pokemon from \(resource.url ?? "unknown"): \(error)")
       return nil
   }
   ```

**根本的な改善案**:
1. **初回起動時の遅延読み込み**
   - 起動時は必要最小限のデータのみ取得（例: 第1世代のみ）
   - 残りはバックグラウンドで段階的に取得

2. **永続的キャッシュの導入**
   - ローカルDBに保存して2回目以降の起動を高速化
   - 初回同期は時間がかかることをユーザーに明示

3. **適応的並列度制御**
   - ネットワーク状況に応じて動的にバッチサイズを調整
   - エラー率が高い場合は自動的に並列度を下げる

**実装の優先度**: 高（暫定対応済み、根本解決は中期的課題）
**推定工数**: 大（1週間 - ローカルDB導入含む）

**関連ファイル**:
- `Pokedex/Data/Network/PokemonAPIClient.swift:115-222`
- `Pokedex/Data/Repositories/PokemonRepository.swift:85, 109`

---

### 2. 技フィルターのパフォーマンス問題

**現状の問題**:
- 技フィルターを適用すると、選択されているポケモン全体（数百〜数千匹）に対してAPI呼び出しを行うため、処理に非常に時間がかかる
- 例: スカーレット・バイオレット（828匹）で技フィルターを適用すると、数十秒〜数分かかる

**原因**:
```swift
// FilterPokemonByMovesUseCase.swift
for pokemon in pokemonList {  // 828匹全てに対して
    let learnMethods = try await moveRepository.fetchLearnMethods(
        pokemonId: pokemon.id,  // APIを1匹ずつ呼び出し
        moveIds: selectedMoves.map { $0.id },
        versionGroup: versionGroup
    )
    // ...
}
```

**補足説明**:
- 828匹には全フォルム（リージョンフォーム、特殊フォームなど）が含まれる
- 実際のスカーレット・バイオレット登場種族は約400種だが、フォルムを含めると2倍以上になる
- 例: bug-buzzで49匹に絞り込めるが、処理完了まで数十秒かかる

**改善案**:
1. **キャッシュ戦略の強化**
   - ポケモンごとの技習得データをローカルDBに保存
   - 初回起動時にバックグラウンドでデータを取得・保存
   - 以降はローカルDBから高速に取得

2. **段階的フィルタリング**
   - まずクライアント側で大まかにフィルタリング（Pokemon.movesを使用）
   - 候補が絞られてからAPI呼び出しで詳細確認

3. **バッチAPI呼び出し**
   - 複数のポケモンデータを一度に取得できるエンドポイントの検討
   - ただし、PokéAPIの仕様上、現状では困難

**実装の優先度**: 高
**推定工数**: 中（2-3日）

---

## 🟡 中優先度の課題

### 2. 828匹問題の分析と最適化

**現状の問題**:
- スカーレット・バイオレットで828匹のポケモンが表示されている
- 技フィルターでは、この828匹全てに対してAPI呼び出しを行うため処理が非常に遅い

**828匹の内訳**:
```
スカーレット・バイオレット選択時:
- 表示されるポケモン: 828匹
  - 基本種族: 約400種
  - リージョンフォーム: アローラ、ガラル、ヒスイなど（必要）
  - フォルムチェンジ: パルデアケンタロス3種など（必要）
  - その他のバリエーション
```

**注意**: リージョンフォームやフォルムチェンジは性能が異なるため、別個に表示する必要がある

**問題の本質**:
- 表示されているポケモン数自体は妥当
- **技フィルターで全ポケモンに対してAPI呼び出しをしている**ことがボトルネック
- 1匹あたり約0.1秒 × 828匹 = 約80秒かかる

**改善案**:
1. **技習得データの事前キャッシュ**
   - 初回ロード時にバックグラウンドで全ポケモンの技データを取得
   - ローカルDBに保存し、技フィルター時はDBから高速検索

2. **並列処理の最適化**
   ```swift
   // 現状: 順次処理
   for pokemon in pokemonList {
       let methods = try await fetchLearnMethods(pokemon.id)
   }

   // 改善案: バッチ処理 + 並列化
   await withTaskGroup { group in
       for batch in pokemonList.chunked(into: 50) {
           group.addTask {
               await processBatch(batch)
           }
       }
   }
   ```

3. **クライアント側での事前フィルタリング**
   - `Pokemon.moves`プロパティを活用
   - まず技名で大まかにフィルタリング → 候補を絞ってからAPI呼び出し

**実装の優先度**: 中〜高（ユーザー体験に直結）
**推定工数**: 中（2-3日）

**期待される効果**:
- 技フィルター処理時間: 80秒 → 3-5秒（95%削減）
- ユーザー体験の大幅改善

---

### 3. ツールバーの表示問題（長い文字列）

**現状の問題**:
- バージョングループ名が長い場合（「ファイアレッド・リーフグリーン」「スカーレット・バイオレット」など）、ツールバーの他のボタンが隠れてしまう
- 現在は暫定対応として、バージョングループセレクターのテキストを非表示にしている

**暫定対応**:
```swift
// 地球儀アイコンのみ表示
Button {
    activeSheet = .versionGroup
} label: {
    Image(systemName: "globe")  // テキストなし
}
```

**改善案**:
1. **省略表示**
   - 長い名前は省略形で表示（例: "スカーレット・..." → "SV"）
   - `.lineLimit(1)` + `.truncationMode(.tail)` を使用

2. **ツールバーレイアウトの見直し**
   - 重要度の低いボタンを「...」メニューに集約
   - または、タブバーへの移動を検討

**実装の優先度**: 中
**推定工数**: 小（1日）

---

### 3. Menuコンポーネントの不具合

**現状の問題**:
- iOS 26.0シミュレーターで`Menu`コンポーネントが正しく動作しない
- エラー: `Called -[UIContextMenuInteraction updateVisibleMenuWithBlock:] while no context menu is visible.`
- 現在は`.sheet`による実装に変更して回避

**暫定対応**:
- すべてのメニューを`.sheet`で表示

**改善案**:
1. **iOSバージョンによる分岐**
   ```swift
   if #available(iOS 27.0, *) {
       Menu { ... }  // iOS 27以降で修正されている場合
   } else {
       Button + .sheet  // 現在の実装
   }
   ```

2. **Appleのバグ修正待ち**
   - iOS 26.xの既知の問題である可能性
   - 将来のiOSアップデートで解消される可能性あり

**実装の優先度**: 低（現在の回避策で問題なし）
**推定工数**: 小（iOSアップデート待ち）

---

## 🟢 低優先度・将来的な改善

### 4. TM/TR番号の取得

**現状の問題**:
- 技の習得方法で「わざマシン」の場合、TM/TR番号が「TM??」と表示される
- `MoveRepository.parseLearnMethod()`でTODOとして残っている

**実装箇所**:
```swift
// MoveRepository.swift:80
machine: nil  // TODO: TM/TR番号の取得
```

**改善案**:
- PokéAPIの`machine`エンドポイントを使用してTM/TR番号を取得
- キャッシュして再利用

**実装の優先度**: 低
**推定工数**: 小（1日）

---

### 5. 技情報の詳細表示

**現状の問題**:
- 技リストで技名のみ表示されており、タイプや威力などの情報がない
- ユーザーがどの技を選ぶべきか判断しにくい

**改善案**:
1. **技リストの拡張**
   - 技タイプのアイコン表示
   - 威力・命中率の表示
   - 技の説明文（オプション）

2. **技詳細画面の追加**
   - 技をタップすると詳細画面へ遷移
   - 習得可能なポケモン一覧も表示

**実装の優先度**: 低
**推定工数**: 中（2-3日）

---

### 6. オフライン対応

**現状の問題**:
- すべてのデータをAPIから取得しているため、オフラインでは使用できない
- 初回起動時の読み込みに時間がかかる

**改善案**:
1. **ローカルデータベース導入**
   - Core DataまたはSwiftDataを使用
   - ポケモンデータ、技データをローカルに保存

2. **バックグラウンド同期**
   - アプリ起動時にバックグラウンドでデータを更新
   - ユーザーは即座にキャッシュデータを閲覧可能

**実装の優先度**: 低
**推定工数**: 大（1-2週間）

---

### 7. 画像キャッシュの最適化

**現状の問題**:
- Kingfisherを使用しているが、設定が最小限
- 画像の読み込みが遅い場合がある

**改善案**:
1. **Kingfisherの設定最適化**
   - キャッシュサイズの調整
   - プリフェッチの実装
   - 低解像度プレースホルダーの使用

2. **画像形式の最適化**
   - WebPへの対応検討
   - 適切なサイズの画像を選択

**実装の優先度**: 低
**推定工数**: 小（1日）

---

### 8. アクセシビリティの向上

**現状の問題**:
- VoiceOverサポートが不十分
- ダイナミックタイプのサポートが一部のみ

**改善案**:
1. **VoiceOverラベルの追加**
   - すべてのボタン、画像に適切なアクセシビリティラベルを追加

2. **カラーコントラストの改善**
   - WCAG 2.1 AA基準に準拠
   - ダークモード対応の見直し

**実装の優先度**: 低
**推定工数**: 中（2-3日）

---

## 🔧 技術的負債

### 9. テストカバレッジの向上

**現状**:
- 基本的なUseCaseのテストのみ実装
- ViewModelのテストが不足
- UIテストが未実装

**改善案**:
1. **単体テストの拡張**
   - すべてのUseCaseとViewModelをカバー
   - 目標カバレッジ: 80%以上

2. **UIテストの追加**
   - 主要な画面遷移のテスト
   - フィルタリング機能のE2Eテスト

**実装の優先度**: 中
**推定工数**: 大（1週間）

---

### 10. エラーハンドリングの統一

**現状の問題**:
- エラーハンドリングが画面ごとに異なる
- ユーザーへのエラーメッセージが統一されていない

**改善案**:
1. **共通エラーハンドリング機構**
   - ErrorHandlerプロトコルの導入
   - エラーメッセージの国際化

2. **リトライ機構の統一**
   - 自動リトライの実装
   - ユーザーへの適切なフィードバック

**実装の優先度**: 低
**推定工数**: 中（2-3日）

---

## 📊 パフォーマンス改善のためのベンチマーク

### 技フィルター処理時間（参考値）

| バージョングループ | ポケモン数 | 処理時間（推定） |
|-------------------|-----------|-----------------|
| 赤・緑・青 | 151匹 | 15-30秒 |
| 金・銀 | 251匹 | 25-50秒 |
| スカーレット・バイオレット | 828匹 | 80-160秒 |
| 全国図鑑 | 1000匹以上 | 100秒以上 |

**目標**: すべてのバージョンで **3秒以内** に処理完了

---

## 🎯 優先的に取り組むべき課題

1. **技フィルターのパフォーマンス改善**（高優先度）
   - ユーザー体験に直接影響
   - 現在の最大の課題

2. **テストカバレッジの向上**（中優先度）
   - 品質保証のため
   - リファクタリングの安全性確保

3. **ツールバー表示の改善**（中優先度）
   - UI/UXの改善
   - 比較的小規模な修正

---

## 📝 メモ

### 技フィルターの代替案

PokéAPIの制約上、現在のアプローチには限界があります。以下の選択肢を検討：

**Option A: ローカルDB + 初回同期**
- メリット: 2回目以降は高速
- デメリット: 初回同期に時間がかかる、アプリサイズ増加

**Option B: クラウドバックエンド構築**
- メリット: 最も高速、柔軟な検索が可能
- デメリット: インフラコスト、開発工数大

**Option C: 現状維持 + UI改善**
- メリット: 実装コスト最小
- デメリット: 根本的な解決にならない

**推奨**: Option A（ローカルDB + 初回同期）

---

## 🔄 変更履歴

| 日付 | 内容 | 担当 |
|------|------|------|
| 2025-10-05 | 初版作成 | Claude |


# Pokedex-SwiftUI 要件定義書 v2.0

**作成日:** 2025-10-05  
**バージョン:** 2.0.0  
**対象:** 機能拡張・改善フェーズ

---

## 📝 改訂履歴

| バージョン | 日付 | 変更内容 |
|----------|------|---------|
| 2.0.0 | 2025-10-05 | 初版作成。バージョングループ別表示、全ポケモン対応、フィルター・ソート機能拡張 |

---

## 🎯 概要

本要件定義書は、Pokedex-SwiftUI v1.0に対する機能拡張および改善を定義するものです。主に以下の領域をカバーします:

1. ポケモン一覧のUI/UX改善
2. バージョングループ別表示対応と全ポケモン対応
3. 検索・フィルター・ソート機能の拡張
4. パフォーマンスとユーザー体験の最適化

---

## 🚀 機能要件

### 1. ポケモン一覧行(PokemonRow)の表示項目拡張

#### 1.1 概要
ユーザーが詳細画面に遷移せずに、ポケモンの重要情報を一覧で比較できるよう、表示項目を拡張する。

#### 1.2 背景・目的
- **現状の課題:** 一覧画面では名前、スプライト、タイプのみ表示されており、特性や強さ(種族値)を知るには詳細画面への遷移が必須
- **改善の価値:** 一覧画面での情報量を増やし、ポケモン選択の判断材料を提供することでUXを向上

#### 1.3 機能詳細

**1.3.1 表示項目**

| 項目 | 現状 | v2.0 |
|-----|------|------|
| スプライト画像 | ✅ 表示 | ✅ 表示(継続) |
| 名前 | ✅ 表示 | ✅ 表示(継続) |
| タイプ | ✅ 表示 | ✅ 表示(継続) |
| 特性 | ❌ 非表示 | ✅ **追加** |
| 種族値 | ❌ 非表示 | ✅ **追加** |

**1.3.2 特性の表示仕様**
- 選択中のバージョングループにおける特性を表示
  - 全国図鑑モード: 最新バージョングループ(scarlet-violet)の特性
  - バージョングループ選択時: そのバージョングループの特性
- 通常特性と隠れ特性を並べて表示
- **表示形式: `特性: [通常特性名] [隠れ特性名]`**
- 表示例: `特性: しんりょく ようりょくそ` (フシギダネの場合)
- 隠れ特性がない場合は通常特性のみ表示
  - 例: `特性: しんりょく`
- 通常特性が複数ある場合はスラッシュ区切り
  - 例: `特性: プレッシャー/きんちょうかん ○○○` (ミュウツーなど)
- 特性名が長い場合は省略表示を検討
- 注意事項:
  - 第1〜2世代バージョングループ(red-blue, yellow, gold-silver, crystal): 特性システムが存在しないため「-」表示
  - 第3〜4世代バージョングループ(ruby-sapphire〜diamond-pearl系): 隠れ特性が存在しないため通常特性のみ

**1.3.3 種族値の表示仕様**

**全ステータス表示**
- HP / 攻撃 / 防御 / 特攻 / 特防 / 素早さ / 合計 のすべてを表示
- 表示形式: `HP-攻撃-防御-特攻-特防-素早さ (合計)`
- 表示例: `45-49-49-65-65-45 (318)` (フシギダネの場合)

**表示の工夫:**
- コンパクトに数値のみ表示し、ハイフン区切り
- 合計値は括弧で強調
- レイアウトに応じて改行や省略形式も検討
  - リスト表示: 1行で全表示
  - グリッド表示: 2行に分けるなど

**代替表示案(スペースが限られる場合):**
- ラベル付き: `H45-A49-B49-C65-D65-S45 (318)`
  - H=HP, A=Attack, B=Defense(Body), C=Special Attack, D=Special Defense, S=Speed

**1.3.4 レイアウト設計**

**リスト表示モード:**
```
┌─────────────────────────────────────────────┐
│ [画像] ポケモン名 #001                      │
│        タイプ1 タイプ2                      │
│        特性: しんりょく ようりょくそ        │
│        種族値: 45-49-49-65-65-45 (318)      │
└─────────────────────────────────────────────┘
```

**グリッド表示モード:**
```
┌──────────────────┐
│   [画像]         │
│ ポケモン名       │
│ タイプ1 タイプ2  │
│ しんりょく       │
│ ようりょくそ     │
│ 45-49-49         │
│ 65-65-45(318)    │
└──────────────────┘
```
※グリッド表示では特性を2行、種族値を2行に分けるなど、見やすさを優先

#### 1.4 技術実装方針

**1.4.1 Domain層の変更**
- `PokemonListItemEntity`に以下のプロパティを追加:
  - `abilities: [AbilityInfo]` - 特性情報
  - `baseStats: BaseStats` - 種族値情報
  
```swift
struct AbilityInfo {
    let name: String
    let isHidden: Bool
}

struct BaseStats {
    let hp: Int
    let attack: Int
    let defense: Int
    let specialAttack: Int
    let specialDefense: Int
    let speed: Int
    
    var total: Int {
        hp + attack + defense + specialAttack + specialDefense + speed
    }
}
```

**1.4.2 Data層の変更**
- `PokemonRepository`で特性・種族値情報を含めて取得
- DTOからEntityへのマッピングを拡張

**1.4.3 Presentation層の変更**
- `PokemonRow`コンポーネントのレイアウト拡張
- 特性表示用のサブコンポーネント作成: `AbilityView`
- 種族値表示用のサブコンポーネント作成: `BaseStatsView`

**1.4.4 キャッシュ戦略**
- 既存のメモリキャッシュに特性・種族値情報も含める
- キャッシュキーは変更なし(ポケモンID単位)

#### 1.5 受け入れ基準
- [ ] リスト表示モードで特性と種族値が表示される
- [ ] グリッド表示モードで特性と種族値が表示される
- [ ] 通常特性と隠れ特性が区別されて表示される
- [ ] 種族値合計が正確に計算・表示される
- [ ] レイアウトが崩れず、全体のデザインと調和している

---

### 2. 特性による絞り込み機能

#### 2.1 概要
検索・フィルター画面に特性フィルターを追加し、特定の特性を持つポケモンを絞り込めるようにする。

#### 2.2 背景・目的
- **現状の課題:** タイプフィルターのみで、特性での絞り込みができない
- **改善の価値:** 対戦やパーティ編成時に、特定の特性を持つポケモンを素早く探せる
- **全国図鑑モードでの動作:** 
  - 最新世代(第9世代)の特性として扱い、フィルター可能
  - ポケモンの特性はバージョングループによって変わるが、全国図鑑では最新仕様を採用

#### 2.3 機能詳細

**2.3.1 UI配置**
- 検索画面(SearchView)の「タイプフィルター」セクションの下に「特性フィルター」セクションを追加

**2.3.2 バージョングループ選択との連動**
- **全国図鑑モードの場合:**
  - 特性フィルターは有効
  - 最新世代(第9世代)の特性として扱う
  - 全特性が選択肢に表示される
  
- **バージョングループ選択済みの場合:**
  - 特性フィルターは有効
  - 選択したバージョングループにおける特性のみ選択肢に表示
  - 第1〜2バージョングループ選択時は特性フィルターを無効化(特性システムが存在しないため)

**2.3.3 フィルター仕様**
- 複数特性の選択可能
- フィルター条件: OR条件(選択した特性のいずれかを持つポケモンを表示)
- 通常特性・隠れ特性の両方を対象に絞り込み
- 選択した特性はタグ形式で表示、タップで解除

**2.3.3 特性選択方法**
- 特性一覧から選択(チェックボックス形式)
- インクリメンタルサーチ対応(特性名で絞り込み)

**2.3.4 フィルタークリア**
- 既存の「フィルタークリア」ボタンで特性フィルターもクリアされる

#### 2.4 技術実装方針

**2.4.1 Domain層の変更**
- `SearchFilterEntity`に以下を追加:
  - `selectedAbilities: Set<String>` - 選択された特性のセット
  
- 新しいUseCase: `FilterPokemonByAbilityUseCase`
  - 入力: ポケモンリスト、選択された特性セット
  - 出力: フィルター後のポケモンリスト
  - ロジック: 通常特性・隠れ特性の両方をチェック

**2.4.2 Data層の変更**
- 全特性のマスターリストを取得する機能追加
- PokéAPI: `/api/v2/ability/` エンドポイントを使用
- 特性リストのキャッシュ

**2.4.3 Presentation層の変更**
- `SearchView`に特性フィルターセクション追加
- 新しいView: `AbilityFilterView`
  - 特性一覧表示
  - 検索フィールド
  - 選択状態管理

**2.4.4 ViewModel拡張**
- `SearchViewModel`に以下を追加:
  - `@Published var selectedAbilities: Set<String>`
  - `func toggleAbility(_ ability: String)`
  - `func clearAbilityFilter()`

#### 2.5 受け入れ基準
- [ ] 全国図鑑モードで特性フィルターが有効化される
- [ ] 第1〜2バージョングループ選択時は特性フィルターが無効化される(特性システム未実装のため)
- [ ] 無効化時に適切なメッセージが表示される
- [ ] 第3世代以降の選択時に特性フィルターが有効化される
- [ ] 特性フィルターセクションが表示される
- [ ] 複数特性を選択できる
- [ ] 選択した特性でポケモンがフィルタリングされる
- [ ] 通常特性・隠れ特性の両方が絞り込み対象となる
- [ ] 特性名で検索できる
- [ ] フィルタークリアで特性フィルターもクリアされる
- [ ] バージョングループ切り替え時、選択済み特性フィルターがクリアされる

---

### 3. 種族値による並び替え機能

#### 3.1 概要
ポケモン一覧を種族値(合計または個別ステータス)でソートできる機能を追加する。

#### 3.2 背景・目的
- **現状の課題:** 図鑑番号順のみで、強さや特性での並び替えができない
- **改善の価値:** 種族値ランキングや特定ステータスに優れたポケモンを簡単に見つけられる

#### 3.3 機能詳細

**3.3.1 ソートオプション**

| ソート項目 | 説明 |
|----------|------|
| 図鑑番号 | デフォルト。昇順のみ |
| 名前 | あいうえお順(昇順/降順) |
| 種族値合計 | 降順/昇順 |
| HP | 降順/昇順 |
| 攻撃 | 降順/昇順 |
| 防御 | 降順/昇順 |
| 特攻 | 降順/昇順 |
| 特防 | 降順/昇順 |
| 素早さ | 降順/昇順 |

**3.3.2 UI配置**
- 一覧画面上部、リスト/グリッド切り替えボタンの横に「ソート」ボタンを配置
- タップでソートオプションのモーダルまたはドロップダウンを表示

**3.3.3 ソート状態の表示**
- 現在のソート項目をボタンラベルに表示
- 例: 「ソート: 種族値合計↓」

**3.3.4 デフォルト動作**
- 初回表示: 図鑑番号順(昇順)
- フィルター適用後もソート順を維持

#### 3.4 技術実装方針

**3.4.1 Domain層の変更**
- 新しいEnum: `SortOption`
  
```swift
enum SortOption {
    case pokedexNumber
    case name(ascending: Bool)
    case totalStats(ascending: Bool)
    case hp(ascending: Bool)
    case attack(ascending: Bool)
    case defense(ascending: Bool)
    case specialAttack(ascending: Bool)
    case specialDefense(ascending: Bool)
    case speed(ascending: Bool)
}
```

- 新しいUseCase: `SortPokemonUseCase`
  - 入力: ポケモンリスト、ソートオプション
  - 出力: ソート済みポケモンリスト

**3.4.2 Presentation層の変更**
- `PokemonListViewModel`に以下を追加:
  - `@Published var currentSortOption: SortOption = .pokedexNumber`
  - `func changeSortOption(_ option: SortOption)`
  
- 新しいView: `SortOptionView`
  - ソートオプション一覧
  - 昇順/降順の切り替え

#### 3.5 受け入れ基準
- [ ] ソートボタンが表示される
- [ ] 全てのソートオプションで正しくソートされる
- [ ] ソート後もフィルター条件が維持される
- [ ] 現在のソート状態がUIに表示される
- [ ] デフォルトは図鑑番号順

---

### 4. バージョングループ別表示切り替え機能

#### 4.1 概要
ポケモンのバージョングループを選択し、そのバージョングループにおける仕様(タイプ、特性、覚える技など)でポケモン情報を表示する機能。

#### 4.2 背景・目的
- **現状の課題:** 
  - タイプや特性がバージョングループによって異なる場合があるが、最新仕様のみ表示
  - 歴代のゲーム体験と情報が一致しない
- **改善の価値:** 
  - 各バージョングループのゲーム仕様に即した正確な情報提供
  - ユーザーが遊んだバージョングループの情報を確認できる

#### 4.3 機能詳細

**4.3.1 バージョングループの定義**

バージョングループはPokéAPIで定義されているゲームソフトの単位です。

| バージョングループID | 表示名 | 世代 | 主な変更点例 |
|------------------|-------|-----|------------|
| red-blue | 赤・緑・青 | 1 | - |
| yellow | ピカチュウ | 1 | - |
| gold-silver | 金・銀 | 2 | あく・はがねタイプ追加 |
| crystal | クリスタル | 2 | - |
| ruby-sapphire | ルビー・サファイア | 3 | 特性システム導入 |
| emerald | エメラルド | 3 | - |
| firered-leafgreen | ファイアレッド・リーフグリーン | 3 | - |
| diamond-pearl | ダイヤモンド・パール | 4 | 物理・特殊の仕様変更 |
| platinum | プラチナ | 4 | - |
| heartgold-soulsilver | ハートゴールド・ソウルシルバー | 4 | - |
| black-white | ブラック・ホワイト | 5 | 隠れ特性導入 |
| black-2-white-2 | ブラック2・ホワイト2 | 5 | - |
| x-y | X・Y | 6 | フェアリータイプ追加 |
| omega-ruby-alpha-sapphire | オメガルビー・アルファサファイア | 6 | - |
| sun-moon | サン・ムーン | 7 | Zワザ |
| ultra-sun-ultra-moon | ウルトラサン・ウルトラムーン | 7 | - |
| lets-go-pikachu-lets-go-eevee | Let's Go! ピカチュウ・イーブイ | 7 | - |
| sword-shield | ソード・シールド | 8 | ダイマックス |
| brilliant-diamond-shining-pearl | ブリリアントダイヤモンド・シャイニングパール | 8 | - |
| legends-arceus | Pokémon LEGENDS アルセウス | 8 | - |
| scarlet-violet | スカーレット・バイオレット | 9 | テラスタル |

**注:** 同じ世代内でも技の習得方法やポケモンの登場が異なるため、バージョングループ単位での選択が必要です。

**4.3.2 バージョングループ選択UI**
- 一覧画面上部にバージョングループセレクター追加
- ドロップダウン形式（Picker）
- **選択肢:**
  - 「全国図鑑」(全ポケモン・全フォームを表示、デフォルト)
  - 「赤・緑・青」(red-blue)
  - 「ピカチュウ」(yellow)
  - 「金・銀」(gold-silver)
  - 「クリスタル」(crystal)
  - ... 最新まで

**デフォルト動作:**
- 初回起動時: 「全国図鑑」モードで起動
- **全国図鑑モードは最新バージョングループ(scarlet-violet)と同等**
  - 全ポケモン(1〜1302、フォーム含む)を表示
  - タイプ、特性、種族値はすべて最新仕様(scarlet-violet時点)
  - **タイプフィルター・特性フィルターは有効**: scarlet-violet仕様として扱う
  - **技フィルターのみ無効**
    - 理由: 技の習得方法はバージョングループごとに大きく異なり、特定バージョンを明示する必要があるため
    - ユーザーにバージョングループ選択を促すメッセージを表示: 「技で絞り込むにはバージョングループを選択してください」

**バージョングループ選択時の表示:**
- そのバージョングループで登場するポケモンのみ表示
- タイプ、特性、種族値はすべて選択バージョングループでの仕様を表示
- タイプフィルター・特性フィルター・技フィルターがすべて有効化

**4.3.3 バージョングループ別データの違い**

以下の情報がバージョングループによって異なる可能性:
- タイプ(例: サーナイトは第5世代まではエスパー単タイプ、第6世代以降はエスパー・フェアリー)
- 特性(例: ゲンガーは第3〜6バージョングループは「ふゆう」、第7世代以降は「のろわれボディ」)
- 種族値(まれに調整が入る)
- 覚える技

**4.3.4 表示範囲**
- **全国図鑑モード:** 全ポケモン(1〜1025)を表示
- **バージョングループ選択時:** 選択したバージョングループまでに登場したポケモンのみ表示
  - 例: 第1バージョングループ選択時は001〜151のみ、第2バージョングループ選択時は001〜251

**4.3.5 バージョングループ切り替え時の動作**
1. ローディング表示
2. 選択バージョングループのポケモンデータを取得
3. 一覧を再描画
4. 適用中のフィルター・ソートを維持(可能な範囲で)

#### 4.4 技術実装方針

**4.4.1 Domain層の変更**

- 新しいEntity: `GenerationEntity`
  
```swift
struct GenerationEntity {
    let id: Int
    let name: String
    let pokemonSpeciesRange: ClosedRange<Int>
}
```

- `PokemonEntity`の拡張:
  - `generation: Int` - 初登場世代
  - `typesByGeneration: [Int: [PokemonType]]` - 世代別タイプ
  - `abilitiesByGeneration: [Int: [AbilityInfo]]` - 世代別特性

- 新しいUseCase: `FetchPokemonForGenerationUseCase`
  - 入力: 世代ID
  - 出力: そのバージョングループのポケモンリスト

**4.4.2 Data層の変更**

**PokéAPI調査事項:**
- 世代情報の取得: `/api/v2/generation/{id}/`
- バージョングループ別のポケモン種族情報
- タイプ・特性の世代別履歴取得方法

**リポジトリ拡張:**
- `PokemonRepository`に世代パラメータを追加
- `func fetchPokemonList(generation: Int) async throws -> [PokemonListItemEntity]`

**キャッシュ戦略:**
- バージョングループごとにキャッシュを分離
- キャッシュキー: `"pokemon_list_gen\(generation)"`

**4.4.3 Presentation層の変更**

- `PokemonListViewModel`に以下を追加:
  - `@Published var selectedGeneration: Int = 9` // デフォルトは最新世代
  - `@Published var availableGenerations: [GenerationEntity]`
  - `func changeGeneration(_ generation: Int) async`

- 新しいView: `GenerationSelectorView`
  - バージョングループ選択UI
  - 現在選択中のバージョングループを強調表示

#### 4.5 受け入れ基準
- [ ] バージョングループセレクターが表示される
- [ ] バージョングループを切り替えると、そのバージョングループのポケモンのみ表示される
- [ ] バージョングループ別のタイプ・特性が正しく表示される
- [ ] バージョングループ切り替え時にローディングが表示される
- [ ] デフォルトは第9世代(最新)

---

### 5. 全ポケモン対応(第1〜9世代、約1025匹)

#### 5.1 概要
現在の第1世代151匹から、全バージョングループのポケモン約1025匹に対応を拡大する。

#### 5.2 背景・目的
- **現状の課題:** 第1バージョングループのみ対応、ユーザーの選択肢が限定的
- **改善の価値:** 
  - 全ポケモンを網羅し、あらゆるバージョングループのファンに対応
  - バージョングループ別表示機能の前提条件

#### 5.3 機能詳細

**5.3.1 対応範囲**
- 第1世代〜第9バージョングループのポケモン(図鑑番号1〜1025)
- リージョンフォーム、フォルムチェンジは今後の検討課題

**5.3.2 データ取得戦略**

大量データ取得に伴う課題:
- 取得時間が長い(1025件のAPIリクエスト)
- ユーザー待機時間の増加
- メモリ使用量の増加

**段階的ロード戦略:**
1. **初回表示:** 選択バージョングループのポケモンのみ取得(例: 第1世代なら151匹)
2. **バックグラウンドロード:** 残りのバージョングループを優先度順に取得
3. **キャッシュ活用:** 一度取得したデータは再利用

**並列取得の最適化:**
- `TaskGroup`を使用した並列取得
- 同時リクエスト数の制限(PokéAPIの負荷考慮)
- リトライロジックの実装

#### 5.4 技術実装方針

**5.4.1 Domain層の変更**
- `FetchPokemonListUseCase`の拡張:
  - ページネーション対応
  - 世代フィルター対応

**5.4.2 Data層の変更**

**PokemonRepository拡張:**
```swift
protocol PokemonRepository {
    func fetchPokemonList(
        generation: Int?,
        offset: Int,
        limit: Int
    ) async throws -> [PokemonListItemEntity]
    
    func fetchAllPokemon(
        progressHandler: (Double) -> Void
    ) async throws -> [PokemonListItemEntity]
}
```

**並列取得の実装例:**
```swift
func fetchAllPokemon(progressHandler: (Double) -> Void) async throws -> [PokemonListItemEntity] {
    let totalCount = 1025
    let batchSize = 50
    var allPokemon: [PokemonListItemEntity] = []
    
    for batchStart in stride(from: 1, through: totalCount, by: batchSize) {
        let batchEnd = min(batchStart + batchSize - 1, totalCount)
        let batch = try await fetchBatch(from: batchStart, to: batchEnd)
        allPokemon.append(contentsOf: batch)
        
        let progress = Double(batchEnd) / Double(totalCount)
        progressHandler(progress)
    }
    
    return allPokemon
}
```

**5.4.3 Presentation層の変更**
- `PokemonListViewModel`に進捗管理追加:
  - `@Published var loadingProgress: Double = 0.0`
  - `@Published var isBackgroundLoading: Bool = false`

#### 5.5 受け入れ基準
- [ ] 全1025匹のポケモンが取得できる
- [ ] 初回表示は選択バージョングループのみで高速
- [ ] バックグラウンドで残りのバージョングループを取得
- [ ] メモリリークが発生しない
- [ ] エラーハンドリングが適切

---

### 6. ローディングUI改善

#### 6.1 概要
大量データ取得時のユーザー体験を向上させるため、適切なローディング表示を実装する。

#### 6.2 背景・目的
- **現状の課題:** 全ポケモン対応により、データ取得に時間がかかる
- **改善の価値:** 
  - ユーザーにアプリが動作中であることを明示
  - 待機時間のストレス軽減

#### 6.3 機能詳細

**6.3.1 ローディングパターン**

| シーン | ローディングタイプ | 表示内容 |
|-------|---------------|---------|
| 初回起動 | 全画面ローディング | プログレスバー + 進捗率(例: 85/1025) |
| バージョングループ切り替え | 全画面ローディング | スピナー + "読み込み中..." |
| バックグラウンドロード | インジケーター | 画面下部に小さなプログレスバー |
| ページング | スケルトンスクリーン | 一覧の下部に次のアイテムのスケルトン |

**6.3.2 プログレスバー仕様**
- 取得済み件数 / 全体件数を表示
- 例: "ポケモンを読み込み中... 450/1025"
- プログレスバーの進捗に応じてアニメーション

**6.3.3 スケルトンスクリーン仕様**
- PokemonRowの形をしたグレーの矩形
- シマーエフェクト(光沢が流れるアニメーション)

**6.3.4 エラー時の表示**
- ローディング失敗時はエラーメッセージを表示
- リトライボタンを提供

#### 6.4 技術実装方針

**6.4.1 Presentation層の実装**

- 新しいView: `LoadingProgressView`
  
```swift
struct LoadingProgressView: View {
    let progress: Double
    let current: Int
    let total: Int
    
    var body: some View {
        VStack {
            ProgressView(value: progress)
            Text("ポケモンを読み込み中... \(current)/\(total)")
        }
    }
}
```

- 新しいView: `PokemonRowSkeleton`
  - スケルトンスクリーンの実装
  - シマーエフェクトのアニメーション

**6.4.2 ViewModel統合**
- `PokemonListViewModel`から進捗情報を受け取る
- `@Published var loadingProgress: Double`
- `@Published var loadedCount: Int`
- `@Published var totalCount: Int`

#### 6.5 受け入れ基準
- [ ] 初回起動時にプログレスバーが表示される
- [ ] 進捗率が正確に表示される
- [ ] バックグラウンドロード中はインジケーターが表示される
- [ ] スケルトンスクリーンがスムーズにアニメーション
- [ ] エラー時にリトライボタンが表示される

---

### 7. 技による絞り込み機能(複数技対応)

#### 7.1 概要
複数の技を選択し、それらすべてを習得できるポケモンを絞り込む機能。習得方法も併せて表示する。

**⚠️ 重要な制約:**
- **バージョングループが選択されている場合のみ利用可能**
- 全国図鑑モード(世代未選択)では技フィルターは無効化

#### 7.2 背景・目的
- **現状の課題:** 特定の技構成が可能なポケモンを探すのが困難
- **改善の価値:** 
  - パーティ構築時の利便性向上
  - 育成計画を立てやすくなる
- **世代指定が必須の理由:**
  - 技の習得可否はバージョングループによって大きく異なる
  - 技自体が存在しないバージョングループもある
  - 習得方法(TM番号など)もバージョングループごとに変わる

#### 7.3 機能詳細

**7.3.1 UI配置**
- 検索画面に「技フィルター」セクションを追加
- 特性フィルターの下に配置

**7.3.2 バージョングループ選択との連動**
- **世代未選択(全国図鑑モード)の場合:**
  - 技フィルターセクションは無効化(グレーアウト)
  - 「バージョングループを選択してください」とメッセージ表示
  
- **バージョングループ選択済みの場合:**
  - 技フィルターが有効化
  - 選択したバージョングループで存在する技のみ選択肢に表示
  - 選択したバージョングループでの習得可否を判定

**7.3.3 技選択仕様**
- 技名でインクリメンタルサーチ
- 選択した技はタグ形式で表示
- タグをタップで選択解除
- 最大選択数: 4技(ポケモンの技スロット数に合わせる)

**7.3.4 フィルター条件**
- AND条件: 選択したすべての技を習得できるポケモンを表示
- 選択中のバージョングループで習得可能かを判定

**7.3.5 習得方法の表示**

絞り込み結果の各ポケモンに対し、選択した技の習得方法を表示:

| 習得方法 | 表示例 |
|---------|-------|
| レベルアップ | Lv.25 |
| わざマシン | TM15 |
| わざレコード | TR03 |
| タマゴ技 | タマゴ |
| 教え技 | 教え技 |
| 進化時 | 進化時 |

**表示フォーマット例:**
```
フシギバナ
├─ ソーラービーム: Lv.32
├─ ヘドロばくだん: TM36
├─ じしん: TM26
└─ ねむりごな: Lv.15
```

**7.3.6 バージョングループ切り替え時の動作**
- バージョングループを変更すると、選択済み技フィルターは自動クリア
- 理由: 前のバージョングループで選択した技が新しいバージョングループに存在しない可能性があるため

#### 7.4 技術実装方針

**7.4.1 Domain層の変更**

- 新しいEntity: `MoveEntity`
  
```swift
struct MoveEntity {
    let id: Int
    let name: String
    let type: PokemonType
    let generation: Int
}
```

- 新しいEntity: `MoveLearnMethod`
  
```swift
enum MoveLearnMethodType {
    case levelUp(level: Int)
    case machine(number: String) // TM/TR番号
    case egg
    case tutor
    case evolution
}

struct MoveLearnMethod {
    let move: MoveEntity
    let method: MoveLearnMethodType
    let generation: Int
}
```

- 新しいUseCase: `FilterPokemonByMovesUseCase`
  - 入力: ポケモンリスト、選択された技リスト、世代
  - 出力: すべての技を習得できるポケモンリストと習得方法

**7.4.2 Data層の変更**

**PokéAPI仕様:**
- 技情報: `/api/v2/move/{id}/`
- ポケモンが覚える技: `/api/v2/pokemon/{id}/moves`

**Repository拡張:**
```swift
protocol MoveRepository {
    func fetchAllMoves(generation: Int?) async throws -> [MoveEntity]
    func fetchLearnMethods(
        pokemonId: Int,
        moveIds: [Int],
        generation: Int
    ) async throws -> [MoveLearnMethod]
}
```

**キャッシュ戦略:**
- 技マスターリストをキャッシュ
- 習得方法もポケモンIDごとにキャッシュ

**7.4.3 Presentation層の変更**

- `SearchViewModel`に以下を追加:
  - `@Published var selectedMoves: [MoveEntity] = []`
  - `@Published var availableMoves: [MoveEntity] = []`
  - `func addMove(_ move: MoveEntity)`
  - `func removeMove(_ move: MoveEntity)`

- 新しいView: `MoveFilterView`
  - 技検索フィールド
  - 選択済み技のタグ表示
  - 技リスト

- `PokemonRow`の拡張:
  - 技フィルター適用時は習得方法を表示

#### 7.5 受け入れ基準
- [ ] 世代未選択時は技フィルターが無効化される
- [ ] 無効化時に適切なメッセージが表示される
- [ ] バージョングループ選択時に技フィルターが有効化される
- [ ] 技フィルターセクションが表示される
- [ ] 技名で検索できる
- [ ] 複数技を選択できる(最大4つ)
- [ ] 選択した全技を習得できるポケモンが絞り込まれる
- [ ] 各技の習得方法が表示される
- [ ] 選択中のバージョングループで存在する技のみ選択肢に表示される
- [ ] 選択中のバージョングループでの習得可否が正しく判定される
- [ ] フィルタークリアで技フィルターもクリアされる
- [ ] バージョングループ切り替え時、選択済み技フィルターがクリアされる

---

### 8. 詳細画面からの復帰時スクロール位置保持

#### 8.1 概要
詳細画面から一覧画面に戻る際、元のスクロール位置を保持する機能。

#### 8.2 背景・目的
- **現状の課題:** 詳細画面から戻ると一覧の先頭に戻ってしまう
- **改善の価値:** ブラウジング体験が大幅に向上し、ユーザーストレスが軽減

#### 8.3 機能詳細

**8.3.1 動作仕様**
1. ユーザーが一覧画面でポケモンをタップ
2. 詳細画面へ遷移
3. 戻るボタンまたはスワイプで一覧画面へ復帰
4. **復帰時、タップしたポケモンの位置にスクロール**

**8.3.2 対応画面**
- リスト表示モード
- グリッド表示モード

**8.3.3 スクロール動作**
- アニメーション付きでスクロール(スムーズ)
- 選択したポケモンが画面中央付近に表示されるよう調整

#### 8.4 技術実装方針

**8.4.1 SwiftUIの実装方法**

- `ScrollViewReader`と`.scrollTo()`の活用
  
```swift
ScrollViewReader { proxy in
    List(viewModel.pokemonList) { pokemon in
        PokemonRow(pokemon: pokemon)
            .id(pokemon.id)
            .onTapGesture {
                viewModel.selectPokemon(pokemon)
            }
    }
    .onChange(of: viewModel.selectedPokemonId) { _, newValue in
        if let id = newValue {
            withAnimation {
                proxy.scrollTo(id, anchor: .center)
            }
        }
    }
}
```

**8.4.2 ViewModel層の変更**

- `PokemonListViewModel`に以下を追加:
  - `@Published var selectedPokemonId: Int?`
  - `func selectPokemon(_ pokemon: PokemonListItemEntity)`
  - 詳細画面から戻る際、`selectedPokemonId`を維持

**8.4.3 ナビゲーション管理**
- `NavigationStack`を使用
- ナビゲーションスタックの状態を適切に管理

#### 8.5 受け入れ基準
- [ ] 詳細画面から戻ると元の位置にスクロールされる
- [ ] スクロールがスムーズにアニメーション
- [ ] リスト表示モードで正しく動作
- [ ] グリッド表示モードで正しく動作
- [ ] 選択したポケモンが画面中央付近に表示される

---

## 📊 実装優先度・フェーズ分け

### フェーズ1: 基盤改善(すぐに着手可能・価値大)

**目的:** UX改善とデータ表示の充実

| 機能 | 工数見積 | 価値 | 備考 |
|-----|---------|------|------|
| 8. スクロール位置保持 | 小 | 高 | 技術的に独立、即座にUX改善 |
| 1. PokemonRow拡張 | 中 | 高 | 既存データ活用、見た目向上 |
| 3. 種族値ソート | 小 | 中 | 実装容易、ユーザー要望高 |

**完了条件:**
- ユーザーが一覧画面でより多くの情報を得られる
- 詳細画面への遷移が必要なケースが減る

---

### フェーズ2: フィルター・検索の充実(中程度の実装工数)

**目的:** ポケモン検索の柔軟性向上

| 機能 | 工数見積 | 価値 | 備考 |
|-----|---------|------|------|
| 2. 特性フィルター | 中 | 中 | PokemonRow拡張と連携 |
| 5. ローディングUI改善 | 中 | 中 | フェーズ3の準備 |

**完了条件:**
- タイプ・特性・種族値による多角的な検索が可能
- ローディング表示が適切に実装されている

---

### フェーズ3: 大規模機能追加(アーキテクチャ影響大)

**目的:** 全ポケモン対応とバージョングループ別表示

| 機能 | 工数見積 | 価値 | 備考 |
|-----|---------|------|------|
| 5. 全ポケモン対応 | 大 | 高 | データ量増加、パフォーマンス最適化必須 |
| 4. バージョングループ別表示 | 大 | 高 | アーキテクチャへの影響大 |

**完了条件:**
- 全1025匹のポケモンに対応
- 世代ごとの仕様差を正確に反映
- パフォーマンスが許容範囲内

---

### フェーズ4: 応用機能(フェーズ3完了後)

**目的:** 上級ユーザー向け機能の追加

| 機能 | 工数見積 | 価値 | 備考 |
|-----|---------|------|------|
| 7. 技による絞り込み | 大 | 中 | 世代対応が前提、実装複雑 |

**完了条件:**
- 複数技での絞り込みが可能
- 習得方法まで表示される

---

## 🏗️ アーキテクチャへの影響

### Domain層の拡張

**新しいEntity:**
- `GenerationEntity` - 世代情報
- `MoveEntity` - 技情報
- `MoveLearnMethod` - 技習得方法
- `SortOption` - ソートオプション(Enum)

**新しいUseCase:**
- `FilterPokemonByAbilityUseCase` - 特性フィルター
- `FilterPokemonByMovesUseCase` - 技フィルター
- `SortPokemonUseCase` - ソート
- `FetchPokemonForGenerationUseCase` - 世代別ポケモン取得
- `FetchAllGenerationsUseCase` - 世代リスト取得

**既存Entityの拡張:**
- `PokemonListItemEntity`:
  - `abilities: [AbilityInfo]` 追加
  - `baseStats: BaseStats` 追加
  - `generation: Int` 追加

---

### Data層の拡張

**Repository拡張:**
- `PokemonRepository`:
  - 世代パラメータ対応
  - ページネーション対応
  - 進捗ハンドラー対応

**新しいRepository:**
- `MoveRepository` - 技情報取得
- `GenerationRepository` - 世代情報取得

**新しいDTO:**
- バージョングループ別データのマッピング
- 技習得方法のマッピング

**キャッシュ戦略の見直し:**
- 世代ごとのキャッシュ分離
- 大量データ対応(メモリ管理)
- キャッシュ有効期限の設定

---

### Presentation層の拡張

**新しいView:**
- `GenerationSelectorView` - バージョングループ選択
- `SortOptionView` - ソートオプション選択
- `AbilityFilterView` - 特性フィルター
- `MoveFilterView` - 技フィルター
- `LoadingProgressView` - プログレスバー付きローディング
- `PokemonRowSkeleton` - スケルトンスクリーン

**既存Viewの拡張:**
- `PokemonRow`:
  - 特性表示追加
  - 種族値表示追加
  - 技習得方法表示追加(技フィルター適用時)
  
- `SearchView`:
  - 特性フィルターセクション追加
  - 技フィルターセクション追加

**ViewModel拡張:**
- `PokemonListViewModel`:
  - `selectedGeneration: Int`
  - `currentSortOption: SortOption`
  - `loadingProgress: Double`
  - `selectedPokemonId: Int?`
  
- `SearchViewModel`:
  - `selectedAbilities: Set<String>`
  - `selectedMoves: [MoveEntity]`
  - `includeHiddenAbilities: Bool`

---

## 🧪 テスト戦略

### ユニットテスト

**Domain層:**
- 各新規UseCaseのテスト
- フィルター・ソートロジックのテスト
- バージョングループ別データ取得のテスト

**Presentation層:**
- ViewModelの状態管理テスト
- フィルター・ソート適用時の動作テスト
- ローディング状態の遷移テスト

**想定テストケース数:** 約30〜40件追加

---

### 統合テスト

- PokéAPIとの通信テスト(Mockサーバー使用)
- 大量データ取得のパフォーマンステスト
- メモリリークテスト

---

### UIテスト

- スクロール位置保持の動作確認
- 各フィルターの組み合わせテスト
- ローディング表示の確認

---

## 📝 非機能要件

### パフォーマンス

- 一覧画面の初回表示: 2秒以内
- バージョングループ切り替え: 3秒以内
- スクロール: 60fps維持
- メモリ使用量: 200MB以下(全ポケモンキャッシュ時)

---

## 💾 データ保持・キャッシュ戦略

### 画像キャッシュ(Kingfisher活用)

**現状の課題:**
- 全ポケモン対応により、画像数が約1025匹 × 2種類(通常/色違い) = 2050枚以上
- メモリキャッシュのみでは端末リソースを圧迫
- アプリ再起動時に毎回ダウンロードが必要

**Kingfisherによる解決策:**

```swift
// Kingfisherの設定
ImageCache.default.memoryStorage.config.totalCostLimit = 100 * 1024 * 1024 // 100MB
ImageCache.default.memoryStorage.config.countLimit = 150 // 最大150枚
ImageCache.default.diskStorage.config.sizeLimit = 500 * 1024 * 1024 // 500MB

// 使用例
KFImage(URL(string: pokemon.spriteUrl))
    .placeholder {
        ProgressView()
    }
    .retry(maxCount: 3, interval: .seconds(2))
    .cacheMemoryOnly(false) // ディスクキャッシュも有効化
```

**メリット:**
- **ディスクキャッシュ:** 一度ダウンロードした画像は永続化され、再起動後も利用可能
- **メモリ管理:** 自動的にメモリを解放し、最適な画像数を保持
- **プリフェッチ:** スクロール前に次の画像を先読みしてスムーズな表示
- **リトライ機能:** ネットワークエラー時の自動再試行

### ポケモンデータキャッシュ

**メモリキャッシュ(現状維持):**
- 一覧表示用の軽量データ: メモリキャッシュ
- セッション中のみ有効

**ディスクキャッシュ(今後の検討):**
現時点では対象外だが、以下のような実装も検討可能:
- UserDefaultsやCoreDataで基本データを永続化
- オフライン対応の基盤

**キャッシュ戦略まとめ:**

| データ種別 | キャッシュ方法 | 保持期間 | 備考 |
|----------|------------|---------|------|
| スプライト画像 | Kingfisher(メモリ+ディスク) | 永続 | 500MB上限 |
| ポケモン一覧データ | メモリキャッシュ(Dictionary) | セッション中 | バージョングループごとに分離 |
| 詳細データ | メモリキャッシュ | セッション中 | - |
| 技マスターリスト | メモリキャッシュ | セッション中 | 世代ごと |
| 特性マスターリスト | メモリキャッシュ | セッション中 | - |

---

### アクセシビリティ

- VoiceOver対応
- Dynamic Type対応(文字サイズ調整)
- コントラスト比の確保

---

### エラーハンドリング

- ネットワークエラー時のリトライ機能
- タイムアウト処理(30秒)
- エラーメッセージのユーザーフレンドリーな表示

---

### PokéAPI利用ポリシー遵守

- フェアユース・ポリシーの遵守
- リクエスト頻度の制限(並列リクエスト数: 最大10)
- キャッシュの積極的活用

---

## 🚫 対象外機能(今回は実装しない)

以下の機能は本要件v2.0の対象外とする:

- お気に入り機能(永続化層の追加が必要)
- タイプ相性チェッカー
- ポケモン比較機能
- ウィジェット対応
- 完全なオフライン対応(永続化が必要)
- 説明文(フレーバーテキスト)の表示
- 出現場所の表示
- 鳴き声再生機能
- ダークモード対応
- リージョンフォーム対応
- フォルムチェンジ対応
- メガシンカ・ダイマックス等の特殊形態

---

## 📚 参考資料

- [PokéAPI ドキュメント](https://pokeapi.co/docs/v2)
- [既存要件定義書(v1.0)](./requirements.md)
- [既存設計書](./design.md)
- SwiftUI公式ドキュメント

---

## 🔄 更新履歴

| 日付 | バージョン | 更新内容 |
|-----|----------|---------|
| 2025-10-05 | 2.0.0 | 初版作成 |

---

**文書管理:**
- ファイル名: `requirements_v2.md`
- 配置場所: `docs/`
- 関連文書: `requirements.md`, `design.md`
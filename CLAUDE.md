# Claude Code - 開発ガイドライン

**プロジェクト:** Pokedex-SwiftUI
**対象:** Claude Code
**最終更新:** 2025-10-15

---

## 📋 目次

1. [ブランチ戦略](#ブランチ戦略)
2. [コミット戦略](#コミット戦略)
3. [マージ戦略](#マージ戦略)
4. [作業フロー](#作業フロー)
5. [コード品質基準](#コード品質基準)
6. [禁止事項](#禁止事項)
7. [エラー対応](#エラー対応)
8. [コミュニケーション](#コミュニケーション)
9. [プロジェクト固有のルール](#プロジェクト固有のルール)

---

## ブランチ戦略

### ブランチ命名規則

| 目的 | プレフィックス | 例 |
|-----|-------------|-----|
| 機能追加 | `feature/` | `feature/scroll-position` |
| バグ修正 | `fix/` | `fix/cache-issue` |
| リファクタリング | `refactor/` | `refactor/repository-layer` |
| ドキュメント | `docs/` | `docs/update-readme` |
| テスト | `test/` | `test/add-usecase-tests` |

### ブランチ作成ルール

**必須事項:**
- ✅ **作業前に必ずブランチを作成すること**
- ✅ ブランチ作成前にユーザーに確認を求める
- ✅ ブランチ名は英語、kebab-case形式
- ✅ 1つのブランチで1つの機能/修正のみを扱う

**禁止事項:**
- ❌ mainブランチでの直接作業
- ❌ ユーザーの承認なしでのブランチ作成
- ❌ 曖昧なブランチ名(例: `temp`, `test`, `fix`)

**ブランチ作成時の確認テンプレート:**
```
次の作業のために新しいブランチを作成します:

作業内容: [機能名や修正内容]
ブランチ名: feature/xxx または fix/xxx

このブランチを作成してよろしいですか?
```

---

## コミット戦略

### コミット前の必須確認事項

**絶対ルール:**
- ❌ **ビルドが成功するまでコミットしてはいけない**
- ❌ **ビルド確認なしでコミットすることは絶対に禁止**
- ❌ **余計なファイル（.bak、.log、.DS_Store等）をコミットしてはいけない**
- ✅ **必ずビルドを実行し、成功を確認してからユーザーに確認を求める**
- ✅ **git statusで不要なファイルがないか必ず確認する**
- ✅ **コミット確認時は必ずシミュレータでアプリを起動した状態にする**

**確認手順:**
1. **コード変更後、必ずビルドを実行**
2. ビルドエラーがあれば修正
3. ビルド成功を確認
4. **シミュレータにインストールして起動確認**
5. **git statusで余計なファイルがないか確認**
   - `.bak`（バックアップファイル）
   - `.log`（ログファイル）
   - `.DS_Store`（macOSシステムファイル）
   - `build.log`（ビルドログ）
   - その他の一時ファイル
6. 余計なファイルがあれば削除または.gitignoreに追加
7. **シミュレータでアプリが起動している状態でユーザーに確認を求める**
8. ユーザー承認後、コミット実行

**確認内容:**
1. 変更ファイルのリスト
2. 各ファイルの変更概要
3. 変更理由
4. **ビルド結果（必須）**
5. **シミュレータ起動確認（必須）**
6. テスト結果(該当する場合)

**コミット前の確認テンプレート:**
```
以下の変更をコミットします:

【変更ファイル】
- path/to/file1.swift: [変更内容]
- path/to/file2.swift: [変更内容]

【変更理由】
[なぜこの変更が必要か]

【ビルド結果】
✅ ビルド成功 / ❌ ビルド失敗

【シミュレータ起動確認】
✅ インストール・起動成功、エラー・警告なし / ⚠️ 確認スキップ / ❌ 起動失敗
✅ シミュレータでアプリ起動中（プロセスID: xxxx）- 動作確認可能

【テスト結果】
✅ 全テスト通過 / ⚠️ テストなし / ❌ テスト失敗

【コミットメッセージ】
feat: [件名]

[本文]

シミュレータでアプリを確認の上、このままコミットしてよろしいですか?
```

### コミットメッセージ規則

**Conventional Commits形式:**

```
<type>: <subject>

<body(optional)>

<footer(optional)>
```

**Type一覧:**

| Type | 用途 | 例 |
|------|-----|-----|
| `feat` | 新機能 | `feat: PokemonRowに種族値表示を追加` |
| `fix` | バグ修正 | `fix: キャッシュが正しく動作しない問題を修正` |
| `refactor` | リファクタリング | `refactor: RepositoryのDI実装を改善` |
| `test` | テスト追加・修正 | `test: SortPokemonUseCaseのテストを追加` |
| `docs` | ドキュメント変更 | `docs: READMEにセットアップ手順を追加` |
| `style` | フォーマット | `style: コードフォーマット統一` |
| `chore` | ビルド・設定 | `chore: Kingfisher依存を更新` |

**良いコミットメッセージの例:**
```
feat: PokemonRowに種族値表示を追加

- BaseStatsエンティティを作成
- PokemonListItemEntityにbaseStatsプロパティ追加
- BaseStatsViewコンポーネント実装
- リスト/グリッド両方の表示に対応
```

**悪いコミットメッセージの例:**
```
update code
fix bug
WIP
```

---

## マージ戦略

### マージ禁止事項

**絶対ルール:**
- ❌ **自動マージは絶対に行わないこと**
- ❌ **ユーザーの明示的な承認なしでのマージ禁止**
- ❌ `git merge`を勝手に実行しない

### マージ前チェックリスト

ユーザーに以下を確認:

- [ ] 全ての変更内容をレビュー済み
- [ ] ブランチの目的が達成されている
- [ ] ビルドが成功している
- [ ] テストが全て通過している
- [ ] コンフリクトが解決されている
- [ ] コミットメッセージが適切
- [ ] 不要なファイル・コードが含まれていない

### マージ前の確認テンプレート

```
ブランチのマージ準備が整いました:

【ブランチ】
feature/xxx → main

【コミット数】
X件

【変更ファイル】
- [ファイルリスト]

【変更概要】
[何を実装したか]

【ビルド・テスト】
✅ ビルド成功
✅ 全テスト通過

【マージコマンド】
git checkout main
git merge --no-ff feature/xxx

マージを実行してよろしいですか?
```

### マージ実行後の報告

```
マージが完了しました:

【マージ先】
main

【削除したブランチ】
feature/xxx

【次のステップ】
[あれば提案]
```

---

## 作業フロー

### 新機能実装の標準フロー

**ステップ1: 準備**
1. ユーザーに実装内容を確認
2. ブランチ作成について提案
3. ユーザー承認後、ブランチ作成

**ステップ2: 実装**
4. 実装作業を段階的に進める
5. 各ファイル変更後、ビルド確認
6. 問題があれば即座に報告

**ステップ3: 完了**
7. 実装完了後、変更内容をまとめて報告
8. **ビルドを実行し、成功を確認**
9. ビルドエラーがあれば修正し、再度ビルド
10. **シミュレータにインストールして起動確認（詳細は後述）**
11. **ビルド・起動成功後、コミット前に必ず確認を求める**
12. ユーザー承認後、コミット実行

**ステップ4: マージ**
13. **マージ前に必ず確認を求める**
14. ユーザー承認後、マージ実行
15. ブランチ削除(ユーザーに確認)

### 作業中断・再開時

**中断時:**
- 現在のブランチ名を明示
- 未コミットの変更がある場合は報告
- 作業状況を簡潔に説明

**再開時:**
- ブランチの状態を確認
- 前回からの進捗を確認
- 次のステップを提案

### シミュレータでの動作確認

**絶対ルール:**
- ❌ **ビルドだけでは不十分。必ずシミュレータにインストールして起動確認すること**
- ✅ **ユーザーに動作確認を依頼する前に、必ずシミュレータで起動確認すること**
- ✅ **起動時のエラー・警告を確認し、問題があれば修正すること**

**確認手順（必須）:**

1. **ビルド実行**
```bash
xcodebuild -scheme Pokedex \
  -destination 'platform=iOS Simulator,name=iPhone 17 Pro' \
  clean build
```

2. **.appファイルのパスを確認**
```bash
find /Users/yusuke/Library/Developer/Xcode/DerivedData/Pokedex-* \
  -name "*.app" -type d 2>/dev/null
```

3. **シミュレータの状態確認**
```bash
xcrun simctl list devices | grep "iPhone 17 Pro"
```

4. **アプリをインストール**
```bash
xcrun simctl install booted \
  /Users/yusuke/Library/Developer/Xcode/DerivedData/Pokedex-*/Build/Products/Debug-iphonesimulator/Pokedex.app
```

5. **アプリを起動**
```bash
xcrun simctl launch booted com.yusuke.abe.Pokedex
```

6. **起動ログを確認**
   - クラッシュしていないか
   - エラーログが出ていないか
   - 警告が出ていないか

7. **問題があれば修正**
   - エラー/警告の原因を特定
   - コードを修正
   - 手順1から再実行

**ユーザーへの動作確認依頼時のテンプレート:**
```
シミュレータでの動作確認をお願いします:

【ビルド結果】
✅ ビルド成功

【起動確認】
✅ シミュレータにインストール済み
✅ アプリ起動成功（プロセスID: xxxx）
✅ エラー・警告なし

【確認ポイント】
- [確認してほしい機能1]
- [確認してほしい機能2]

問題なければ、コミットします。
```

**注意事項:**
- シミュレータのデバイスは **iPhone 17 Pro** を使用
- `booted`は現在起動中のシミュレータを指す
- アプリのBundle IDは `com.yusuke.abe.Pokedex`
- ビルド生成物は `DerivedData/Pokedex-*/Build/Products/Debug-iphonesimulator/` 配下

---

## コード品質基準

### Clean Architecture遵守

**各層の責務:**

| 層 | 責務 | 禁止事項 |
|----|------|---------|
| Domain | ビジネスロジック、Entity、UseCase | UIフレームワーク依存、API直接呼び出し |
| Data | API通信、データ変換、Repository実装 | ビジネスロジック、UI要素 |
| Presentation | UI、ViewModel、View | API直接呼び出し、ビジネスロジック |

**依存関係のルール:**
```
Presentation → Domain ← Data
     ↓            ↑
  SwiftUI    Protocols
```

### SwiftUIコーディング規約

**コンポーネントサイズ:**
- 1ファイル200行以内を推奨
- 複雑なViewは複数の小さなコンポーネントに分割

**状態管理:**
- `@Published`は必要最小限に
- `@State`はView内のローカル状態のみ
- ビジネスロジックはViewModel/UseCaseへ

**プレビュー:**
- 全てのViewに`PreviewProvider`を用意
- 複数の状態パターンを用意

**命名規則:**
- View: `XxxxView`
- ViewModel: `XxxxViewModel`
- 明確で説明的な名前を使用

### テスト

**必須テスト:**
- 新しいUseCaseには必ずユニットテスト
- ViewModelの状態変更ロジックにテスト

**テスト命名:**
```swift
func test_{対象}_{条件}_{期待結果}()
```

例:
```swift
func test_sortPokemon_byTotalStats_shouldReturnDescendingOrder()
```

---

## 禁止事項

### 絶対に行ってはいけないこと

| 禁止事項 | 理由 |
|---------|------|
| ❌ mainブランチへの直接コミット | 履歴管理の観点から |
| ❌ **ビルド確認なしでのコミット** | **ビルドエラーを残すため** |
| ❌ **シミュレータ起動確認なしでのコミット** | **実行時エラー・警告を見逃すため** |
| ❌ ユーザー確認なしでのコミット | 意図しない変更を防ぐため |
| ❌ ユーザー確認なしでのマージ | レビュー機会を確保するため |
| ❌ `git push -f` (force push) | 履歴破壊を防ぐため |
| ❌ 既存コミット履歴の書き換え | 他の開発者への影響 |
| ❌ 巨大なコミット(20ファイル以上) | レビュー困難性 |

### 慎重に行うべきこと

| 要注意事項 | 対応方法 |
|----------|---------|
| ⚠️ 複数ファイルの大規模変更 | 段階的に実施、各段階でビルド確認 |
| ⚠️ 既存コードの削除 | 必ず理由を説明、ユーザー承認を得る |
| ⚠️ 依存ライブラリの追加・更新 | 事前にユーザーと相談 |
| ⚠️ アーキテクチャの変更 | 設計ドキュメントと照合、相談 |

---

## エラー対応

### ビルドエラー時

**対応フロー:**
1. エラー内容を正確に報告(エラーメッセージ全文)
2. 原因を分析して説明
3. 修正方法を複数提案(可能な場合)
4. ユーザー承認後、修正実施
5. 修正後、再ビルドして確認

**報告テンプレート:**
```
ビルドエラーが発生しました:

【エラー内容】
[エラーメッセージ全文]

【原因分析】
[なぜエラーが発生したか]

【修正案】
1. [修正方法1]
2. [修正方法2]

どの方法で修正しますか?
```

### コンフリクト発生時

**対応フロー:**
1. コンフリクトの詳細を報告
2. 影響範囲を説明
3. 解決方法をユーザーと相談
4. 手動での解決が必要な場合は明示

**報告テンプレート:**
```
マージコンフリクトが発生しました:

【コンフリクトファイル】
- file1.swift: [コンフリクト箇所]
- file2.swift: [コンフリクト箇所]

【原因】
[なぜコンフリクトが発生したか]

【解決方法の提案】
[どちらを採用すべきか、または手動解決が必要か]
```

---

## コミュニケーション

### 報告すべき内容

**変更報告:**
- 何を変更したか(ファイル名、変更概要)
- なぜ変更したか(理由、目的)
- 影響範囲(他のコードへの影響)
- ビルド・テスト状況

**進捗報告:**
- 現在の作業状態
- 完了した項目
- 残っている項目
- 問題・懸念事項

### 確認を求めるタイミング

**必須確認:**
- ブランチ作成前
- コミット前
- マージ前

**推奨確認:**
- 大きなリファクタリング前
- 依存ライブラリの変更前
- 10ファイル以上の変更前
- アーキテクチャに影響する変更前

### 質問のしかた

**良い質問:**
```
次の実装方針について相談させてください:

【状況】
[現在の状況]

【選択肢】
1. [案1]: メリット・デメリット
2. [案2]: メリット・デメリット

【推奨】
[自分の推奨案と理由]

いかがでしょうか?
```

**悪い質問:**
```
どうしますか?
これでいいですか?
```

---

## プロジェクト固有のルール

### ディレクトリ構造

```
Pokedex/
├── Domain/
│   ├── Entities/        # データ構造
│   ├── UseCases/        # ビジネスロジック
│   └── Interfaces/      # プロトコル定義
├── Data/
│   ├── Repositories/    # Repository実装
│   ├── Network/         # API通信
│   └── DTOs/            # データ変換
├── Presentation/
│   ├── PokemonList/     # 一覧画面
│   ├── PokemonDetail/   # 詳細画面
│   ├── Search/          # 検索画面
│   └── Common/          # 共通UI部品
├── Application/
│   └── DIContainer.swift # 依存性注入
└── Resources/           # リソース
```

### ファイル命名規則

| 種類 | 命名規則 | 例 |
|-----|---------|-----|
| Entity | `XxxxEntity.swift` | `PokemonEntity.swift` |
| UseCase | `XxxxUseCase.swift` | `FetchPokemonListUseCase.swift` |
| Repository | `XxxxRepository.swift` | `PokemonRepository.swift` |
| ViewModel | `XxxxViewModel.swift` | `PokemonListViewModel.swift` |
| View | `XxxxView.swift` | `PokemonListView.swift` |
| Protocol | `Xxxable.swift` または `XxxProtocol.swift` | `Cacheable.swift` |

### インポート順序

```swift
// 1. システムフレームワーク
import SwiftUI
import Foundation

// 2. サードパーティライブラリ
import Kingfisher

// 3. プロジェクト内モジュール
import Domain
import Data
```

### コーディングスタイル

**インデント:**
- スペース4つ(Xcodeデフォルト)

**行の長さ:**
- 120文字以内を推奨

**{}の位置:**
```swift
// Good
func example() {
    // code
}

// Bad
func example() 
{
    // code
}
```

---

## ドキュメント参照

プロジェクトには以下のドキュメントがあります。実装前に必ず参照してください:

### 最新ドキュメント（v4.0）
- `docs/pokedex_requirements_v4.md` - v4.0要件定義書（パフォーマンス改善・永続化キャッシュ）
- `docs/pokedex_design_v4.md` - v4.0設計書（SwiftData、バックグラウンド読み込み）

### v3.0ドキュメント（現行実装）
- `docs/pokedex_requirements_v3.md` - v3.0要件定義書（詳細画面拡充）
- `docs/pokedex_design_v3.md` - v3.0設計書（フォーム・タイプ相性・実数値計算）
- `docs/pokedex_prompts_v3.md` - v3.0実装プロンプト集

### v2.0ドキュメント（基盤）
- `docs/pokedex_requirements_v2.md` - v2.0要件定義書（一覧・検索・フィルター）
- `docs/pokedex_design_v2.md` - v2.0設計書（Clean Architecture基盤）

### その他
- `README.md` - プロジェクト概要
- `docs/future_improvements.md` - 今後の改善案

**特に重要:**
- Clean Architecture + MVVMパターンの遵守
- 各層の責務分離
- PokéAPIの利用方法

**テスト実装状況（2025-10-10）:**
- ✅ v3.0 Domain層テスト完了（46テストケース、899行）
  - CalculateStatsUseCaseTests
  - FetchTypeMatchupUseCaseTests
  - FetchPokemonFormsUseCaseTests
  - MockTypeRepository

---

## まとめ

### 最も重要な3つの原則

1. **自動的な判断でコミット・マージを行わない**
   - 必ずユーザーの承認を待つ
   - 変更内容を明確に報告する

2. **Clean Architectureを遵守する**
   - 各層の責務を守る
   - 依存関係のルールに従う

3. **段階的かつ確実に進める**
   - 小さな変更を積み重ねる
   - 各段階でビルド・シミュレータ起動・テストを確認

### 困ったときは

- 疑問や不明点がある → 必ずユーザーに確認
- ドキュメントと矛盾 → ユーザーに相談
- 複数の選択肢がある → ユーザーに判断を仰ぐ

---

**このガイドラインに従って、安全で高品質なコードを一緒に作っていきましょう!**